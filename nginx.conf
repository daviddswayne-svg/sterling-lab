# Explicit PID file for Docker environment
pid /var/run/nginx.pid;

user root;
events {}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # send logs to stdout/stderr for Docker
    access_log /dev/stdout;
    error_log /dev/stderr;

    # Cache configuration for auth requests
    proxy_cache_path /var/cache/nginx/auth_cache levels=1:2 keys_zone=auth_cache:10m max_size=10m inactive=60m use_temp_path=off;

    server {
        listen 80;

        # Auth validation endpoint (internal only)
        # Auth validation endpoint (internal only)
        location = /auth_validate {
            internal;
            proxy_pass http://127.0.0.1:5000/api/auth/validate;
            proxy_pass_request_body off;
            proxy_set_header Content-Length "";
            proxy_set_header Cookie $http_cookie;
            
            # Cache the auth response
            proxy_cache auth_cache;
            proxy_cache_key "$http_cookie"; # Cache based on session cookie
            proxy_cache_valid 200 5m;       # Cache successful auth for 5 minutes
            proxy_cache_valid 401 1m;       # Cache failures for 1 minute
            proxy_method GET;               # Use GET for auth validation (Flask endpoint is GET)
        }

        # === PUBLIC ROUTES (No Auth Required) ===

        # Login page and static assets
        # Explicit check for style.css to prevent fallback loop
        location = /login/style.css {
            root /app/dashboard;
            expires -1;
        }

        # Explicit check for logo
        location = /login/swaynesystems_logo.png {
            alias /app/dashboard/login/swaynesystems_logo.png;
            expires 1d;
        }

        location /login {
            root /app/dashboard;
            index index.html;
            try_files $uri $uri/ /login/index.html;
        }

        # Auth API endpoints (public - high priority to bypass /api/ auth)
        location ^~ /api/auth/ {
            proxy_pass http://127.0.0.1:5000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # Public chat (no auth)
        location /api/antigravity/public/ {
            proxy_pass http://127.0.0.1:5000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_buffering off;
            proxy_cache off;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            chunked_transfer_encoding off;
            proxy_read_timeout 600s;
        }

        # === PROTECTED ROUTES (Auth Required) ===

        # Main Dashboard (protected)
        location / {
            auth_request /auth_validate;
            error_page 401 = @redirect_login;
            
            root /app/dashboard;
            index index.html;
            try_files $uri $uri/ /index.html;
        }
        
        # Redirect to login on auth failure
        location @redirect_login {
            return 302 /login/;
        }

        # Dashboard assets (protected)
        location /assets/ {
            auth_request /auth_validate;
            error_page 401 = /login;
            
            alias /app/dashboard/assets/;
        }

        # Bedrock Insurance Demo (protected)
        location /bedrock/ {
            auth_request /auth_validate;
            error_page 401 = /login;
            
            alias /app/dashboard/bedrock/;
            try_files $uri $uri/ /bedrock/index.html;
        }

        # Sterling Lab (protected)
        location /lab/ {
            auth_request /auth_validate;
            error_page 401 = /login;
            
            proxy_pass http://127.0.0.1:8501;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_read_timeout 86400;
        }

        # API endpoints (protected, except auth)
        location /api/ {
            auth_request /auth_validate;
            error_page 401 = @api_unauthorized;
            
            proxy_pass http://127.0.0.1:5000/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            
            # SSE Headers
            proxy_buffering off;
            proxy_cache off;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            chunked_transfer_encoding off;
            proxy_read_timeout 600s;
            proxy_send_timeout 600s;
        }

        # API unauthorized response (JSON)
        location @api_unauthorized {
            default_type application/json;
            return 401 '{"error":"Unauthorized","message":"Please login at /login"}';
        }
    }
}
