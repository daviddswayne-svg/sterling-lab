# Explicit PID file for Docker environment
pid /var/run/nginx.pid;

user nginx;
events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # send logs to stdout/stderr for Docker
    access_log /dev/stdout;
    error_log /dev/stderr;

    # Timeouts for Streamlit
    proxy_connect_timeout 600;
    proxy_send_timeout 600;
    proxy_read_timeout 600;
    send_timeout 600;

    server {
        listen 80;
        server_name _;

        # ================================================
        # AUTHELIA AUTHENTICATION INTEGRATION
        # ================================================
        
        # Internal endpoint for Authelia verification (not accessible externally)
        location /_authelia_verify {
            internal;
            proxy_pass http://authelia:9091/api/verify;
            
            # Pass original request info to Authelia
            proxy_set_header X-Original-URL $scheme://$http_host$request_uri;
            proxy_set_header X-Forwarded-Method $request_method;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $http_host;
            proxy_set_header X-Forwarded-URI $request_uri;
            proxy_set_header X-Forwarded-For $remote_addr;
            
            # Authelia response headers
            proxy_pass_request_body off;
            proxy_set_header Content-Length "";
        }

        # Authelia Login Portal
        location /auth {
            proxy_pass http://authelia:9091;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Health check endpoint (NO AUTH REQUIRED for monitoring)
        location = /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        # API Health check (NO AUTH REQUIRED)
        location = /api/health {
            access_log off;
            proxy_pass http://app:5000/health;
        }

        # ================================================
        # PROTECTED ROUTES (REQUIRE AUTHENTICATION)
        # ================================================

        # Dashboard - Static Site (PROTECTED)
        location / {
            # Require authentication
            auth_request /_authelia_verify;
            
            # Handle auth errors (redirect to login)
            error_page 401 =302 https://$host/auth/?rd=$request_uri;
            
            # Serve static dashboard
            root /app/dashboard;
            index index.html;
            try_files $uri $uri/ /index.html;
        }

        # Dashboard Assets (PROTECTED - inherits from /)
        location /assets/ {
            auth_request /_authelia_verify;
            error_page 401 =302 https://$host/auth/?rd=$request_uri;
            
            alias /app/assets/;
            expires 1h;
            add_header Cache-Control "public, immutable";
        }

        # Bedrock Demo (PROTECTED)
        location /bedrock/ {
            auth_request /_authelia_verify;
            error_page 401 =302 https://$host/auth/?rd=$request_uri;
            
            alias /app/dashboard/bedrock/;
            try_files $uri $uri/ /bedrock/index.html;
        }

        # Sterling Lab - Streamlit App (PROTECTED)
        location /lab/ {
            auth_request /_authelia_verify;
            error_page 401 =302 https://$host/auth/?rd=$request_uri;
            
            proxy_pass http://app:8501/lab/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # WebSocket support for Streamlit
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_read_timeout 86400;
        }

        # Streamlit static assets (PROTECTED)
        location /lab/static {
            auth_request /_authelia_verify;
            error_page 401 =302 https://$host/auth/?rd=$request_uri;
            
            proxy_pass http://app:8501/lab/static;
        }
        
        location /lab/healthz {
            auth_request /_authelia_verify;
            error_page 401 =302 https://$host/auth/?rd=$request_uri;
            
            proxy_pass http://app:8501/lab/healthz;
        }
        
        location /lab/vendor {
            auth_request /_authelia_verify;
            error_page 401 =302 https://$host/auth/?rd=$request_uri;
            
            proxy_pass http://app:8501/lab/vendor;
        }
        
        location /lab/stream {
            auth_request /_authelia_verify;
            error_page 401 =302 https://$host/auth/?rd=$request_uri;
            
            proxy_pass http://app:8501/lab/stream;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        # Bedrock API (PROTECTED)
        location /api/ {
            auth_request /_authelia_verify;
            error_page 401 =302 https://$host/auth/?rd=$request_uri;
            
            proxy_pass http://app:5000/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}

