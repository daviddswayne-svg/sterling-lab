# Explicit PID file for Docker environment
pid /var/run/nginx.pid;

user root;
events {}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # send logs to stdout/stderr for Docker
    access_log /dev/stdout;
    error_log /dev/stderr;

    server {
        listen 80;

        # Auth validation endpoint (internal only)
        location = /auth_validate {
            internal;
            proxy_pass http://127.0.0.1:5000/api/auth/validate;
            proxy_pass_request_body off;
            proxy_set_header Content-Length "";
            proxy_set_header Cookie $http_cookie;
        }

        # === PUBLIC ROUTES (No Auth Required) ===

        # Login page
        location /login {
            alias /app/dashboard/login/;
            index index.html;
            try_files $uri $uri/ /login/index.html;
        }

        # Auth API endpoints (public)
        location ~ ^/api/auth/(login|validate) {
            proxy_pass http://127.0.0.1:5000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # Public chat (no auth)
        location /api/antigravity/public/ {
            proxy_pass http://127.0.0.1:5000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_buffering off;
            proxy_cache off;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            chunked_transfer_encoding off;
            proxy_read_timeout 600s;
        }

        # === PROTECTED ROUTES (Auth Required) ===

        # Main Dashboard (protected)
        location = / {
            auth_request /auth_validate;
            error_page 401 = /login;
            
            root /app/dashboard;
            index index.html;
        }

        # Dashboard assets (protected)
        location /assets/ {
            auth_request /auth_validate;
            error_page 401 = /login;
            
            alias /app/dashboard/assets/;
        }

        # Bedrock Insurance Demo (protected)
        location /bedrock/ {
            auth_request /auth_validate;
            error_page 401 = /login;
            
            alias /app/dashboard/bedrock/;
            try_files $uri $uri/ /bedrock/index.html;
        }

        # Sterling Lab (protected)
        location /lab/ {
            auth_request /auth_validate;
            error_page 401 = /login;
            
            proxy_pass http://127.0.0.1:8501;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_read_timeout 86400;
        }

        # API endpoints (protected, except auth)
        location /api/ {
            auth_request /auth_validate;
            error_page 401 = @api_unauthorized;
            
            proxy_pass http://127.0.0.1:5000/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            
            # SSE Headers
            proxy_buffering off;
            proxy_cache off;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            chunked_transfer_encoding off;
            proxy_read_timeout 600s;
            proxy_send_timeout 600s;
        }

        # API unauthorized response (JSON)
        location @api_unauthorized {
            default_type application/json;
            return 401 '{"error":"Unauthorized","message":"Please login at /login"}';
        }
    }
}
